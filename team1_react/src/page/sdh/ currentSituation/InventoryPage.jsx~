import { useEffect, useState, useCallback, useMemo } from 'react';
import InventoryNavigation from '../../../components/sdh/navi/InventoryNavigation.jsx';
import Topline from '../../../components/layout/Topline.jsx';
import InventoryTableBody from '../../../components/sdh/inventory/InventoryTableBody.jsx';

function InventoryPage ()
{
  const [products, setProducts] = useState([]);
  const [selectedLocations, setSelectedLocations] = useState([]);
  const [selectedCorrespondents, setSelectedCorrespondents] = useState([]);
  const [tags, setTags] = useState([]);
  
  const [startDate, setStartDate] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() - 6);
    return d;
  });
  const [endDate, setEndDate] = useState(() => new Date());
  
  const formatDate = useCallback((date, isStart = true) => {
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    const hhmmss = isStart ? '00:00:00' : '23:59:59';
    return `${yyyy}-${mm}-${dd} ${hhmmss}`;
  }, []);
  
  const requestBody = useMemo(() => ({
    tags,
    selectedLocations,
    selectedCorrespondents,
    startDate: formatDate(startDate, true),
    endDate: formatDate(endDate, false),
  }), [tags, selectedLocations, selectedCorrespondents, startDate, endDate, formatDate]);
  
  const fetchInventoryData = useCallback(() => {
    fetch('http://localhost:8080/api/inventory/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody),
    })
      .then(res => {
        if (!res.ok) throw new Error('서버 오류');
        return res.json();
      })
      .then(data => setProducts(data))
      .catch(err => console.error('Fetch 실패:', err));
  }, [requestBody]);
  
  useEffect(() => {
    fetchInventoryData();
  }, [fetchInventoryData]);
  
  return (
    <div className="flex-1 p-6 overflow-y-auto">
      <div className="bg-white rounded shadow p-10 min-x-[100vh] min-h-[80vh]">
        <Topline title="입출고 조회">
          <InventoryNavigation
            selectedLocations={selectedLocations}
            setSelectedLocations={setSelectedLocations}
            selectedCorrespondents={selectedCorrespondents}
            setSelectedCorrespondents={setSelectedCorrespondents}
            startDate={startDate}
            setStartDate={setStartDate}
            endDate={endDate}
            setEndDate={setEndDate}
            tags={tags}
            setTags={setTags}
          />
          <table className="table-fixed border-collapse">
            <thead className="bg-white top-0 z-30">
            <tr className="border-b border-gray-300">
              <th className="cell-style w-[120px]">사진</th>
              <th className="cell-style w-[200px]">제품명</th>
              <th className="cell-style w-[180px]">보관위치</th>
              <th className="cell-style w-[190px]">거래처</th>
              <th className="cell-style w-[130px]">입고량</th>
              <th className="cell-style w-[130px]">출고량</th>
              <th className="cell-style w-[130px]">조정량</th>
              <th className="cell-style w-[130px]">종료재고</th>
            </tr>
            </thead>
            <InventoryTableBody products={products} />
          </table>
        </Topline>
      </div>
    </div>
  );
}

export default InventoryPage;
